#!/bin/bash -e

CALCULATOR_SRC="../../../ctp/src/libctp/calculators"
REFERENCE_SRC="reference/xml"

OUT="$PWD/all.tex"

if [ ! -d $CALCULATOR_SRC ]; then
  echo "error: calculator directory not found"
fi

cd $CALCULATOR_SRC

echo "running doxygen"

doxygen -g > doxygen.log 2>&1
doxygen >> doxygen.log 2>&1

echo "done with doxygen"

echo "% THIS FILE IS AUTOMATICALLY GENERATED, DO NOT TOUCH!!!" > $OUT

for file in latex/*.tex; do
  name=$(sed -ne '/\\subsection{Detailed Description}/,/\\subsection/p' $file | awk '/Callname/{print $NF}')
  if [ ! -z "$name" ]; then
    echo "Generating documentation for calculator $name from $file"
    echo "\subsection{$name}" >> $OUT
    echo "\label{calc:$name}" >> $OUT
    sed -ne '/\\subsection{Detailed Description}/,/\\subsection/p' $file | \
      sed -e '1d' -e '$d' \
      -e '/The documentation for this class was generated from the following/,$d' \
      -e '/Callname/d' \
      -e 's/DoxyItemize/itemize/' >> $OUT
    echo "" >> $OUT
    #echo "Required options: see \calcopt{$name}." >> $OUT

    # including XML files from the reference section.
    echo "\rowcolors{1}{invisiblegray}{white}" >> $OUT
    echo "\input{$REFERENCE_SRC/$name.xml}" >> $OUT
    echo "" >> $OUT

  fi
done



